rule cloudmensis_windowserver {
  meta:
    description = "Yara rule to detect CloudMensis malware for macOS."
    author = "Martin Jaan Leesment"
    reference = "https://www.welivesecurity.com/2022/07/19/i-see-what-you-did-there-look-cloudmensis-macos-spyware/"
    date = "05.12.2022"
  strings:
    $a = "windowserver" nocase
    //$cloud1 = "pCloud"
    //$cloud2 = "Yandex"
    //$cloud3 = "Dropbox"
    $plist = /\/Library\/Launch(Daemons|Agents)\/\.com.apple.{,14}.plist/
    $tcc_new = "/Library/Application Support/com.apple.spotlight/Library/Application Support/com.apple.TCC/"
    $flowEncrypt = {00 46 6c 6f 77 45 6e 63 72 79 70 74 3a 3a 3a 00 }
    $launchctl = "launchctl setenv HOME"
    $cloudCMD = { 63 6c 6f 75 64 43 4d 44 00 5f 61 6c 6c 50 61 73 }
  condition:
    all of them
}

rule cloudmensis_firststage {
  meta:
    description = "Yara rule to detect first-stage component of CloudMensis malware for macOS."
    author = "Martin Jaan Leesment"
    reference = "https://www.welivesecurity.com/2022/07/19/i-see-what-you-did-there-look-cloudmensis-macos-spyware/"
    date = "05.12.2022"
  strings:
    $a = "removeRegistration"
    $b = "rm -f /tmp/mnt/root"
    $c = "speechsynthesisd"
    $d = "diskutil mount"
  condition:
    all of them
}
